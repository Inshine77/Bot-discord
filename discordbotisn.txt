import os
import discord
from discord.ext import commands

# CrÃ©er un objet Intents pour activer les Ã©vÃ©nements appropriÃ©s
intents = discord.Intents.default()
intents.members = True  # Permet de suivre les Ã©vÃ©nements liÃ©s aux membres
intents.reactions = True  # Permet de suivre les rÃ©actions
intents.guilds = True  # Permet d'accÃ©der aux salons et aux rÃ´les
intents.messages = True  # Permet de recevoir les messages

# CrÃ©er une instance du bot avec un prÃ©fixe et les intents
bot = commands.Bot(command_prefix="!", intents=intents)

# Stockage du nombre de tickets ouverts
ticket_count = 0

# ID de la catÃ©gorie oÃ¹ les tickets seront crÃ©Ã©s (remplace par l'ID correct)
CATEGORY_ID = 1338208503294197822  # Remplace avec l'ID de ta catÃ©gorie

# ID du rÃ´le staff qui pourra voir les tickets (remplace par l'ID correct)
STAFF_ROLE_ID = 987654321098765432  # Remplace avec l'ID du rÃ´le staff

# ID du salon ğŸ“¥-demande-ticket et ğŸ“–-reglement
DEMANDE_TICKET_CHANNEL_ID = 1338208503294197822  # Remplace avec l'ID du salon ğŸ“¥-demande-ticket
REGLEMENT_CHANNEL_ID = 1338188693730758791  # Remplace avec l'ID du salon ğŸ“–-reglement

# Ã‰vÃ©nement lorsque le bot est prÃªt
@bot.event
async def on_ready():
    print(f'âœ… Le bot {bot.user} est prÃªt !')

# Ã‰vÃ©nement lorsque le bot voit un membre rejoindre le serveur
@bot.event
async def on_member_join(member):
    channel = discord.utils.get(member.guild.text_channels, name="ğŸ’«-arrivÃ©e")

    if channel:
        print(f"Le membre {member.name} a rejoint le serveur, envoi du message dans {channel.name} !")
        welcome_message = f"""ğŸ‰ **Attention, nouvelle recrue en approche !** ğŸ‰

Bienvenue {member.mention} dans **{member.guild.name}** ! ğŸš€  
Tu viens de poser le pied dans une nouvelle aventure Ã©pique !  

ğŸ”¹ Lis le reglement ğŸ“–  
ğŸ”¹ RÃ©cupÃ¨re ton rÃ´le en rÃ©agissant âœ…  
ğŸ”¹ Fais connaissance avec la communautÃ©   

Installe-toi confortablement, prends une ğŸ• et amuse-toi bien ! ğŸ˜ğŸ®
"""
        await channel.send(welcome_message)
    else:
        print(f"Aucun canal 'ğŸ’«-arrivÃ©e' trouvÃ© dans le serveur !")

# Ã‰vÃ©nement pour gÃ©rer les rÃ©actions d'emoji sur un message spÃ©cifique (rÃ¨glement et tickets)
@bot.event
async def on_raw_reaction_add(payload):
    global ticket_count
    guild = bot.get_guild(payload.guild_id)
    member = guild.get_member(payload.user_id)

    # VÃ©rification pour le salon ğŸ“–-reglement
    if payload.channel_id == REGLEMENT_CHANNEL_ID:
        if str(payload.emoji) == "âœ…":
            role = discord.utils.get(guild.roles, name="Membres")
            if role and member:
                await member.add_roles(role)
                print(f"Le rÃ´le 'Membres' a Ã©tÃ© attribuÃ© Ã  {member.name}.")

    # VÃ©rification pour le salon ğŸ“¥-demande-ticket
    elif payload.channel_id == DEMANDE_TICKET_CHANNEL_ID:
        if str(payload.emoji) == "ğŸŸ¢":
            if member is None or member.bot:
                return

            # IncrÃ©mentation du compteur de tickets
            ticket_count += 1
            ticket_name = f"ticket-{ticket_count}"

            # Trouver la catÃ©gorie oÃ¹ crÃ©er le ticket
            category = discord.utils.get(guild.categories, id=CATEGORY_ID)
            
            # Si la catÃ©gorie n'est pas trouvÃ©e, afficher un message d'erreur
            if category is None:
                print(f"âŒ La catÃ©gorie avec l'ID {CATEGORY_ID} n'a pas Ã©tÃ© trouvÃ©e.")
                return

            # CrÃ©er le salon privÃ©
            overwrites = {
                guild.default_role: discord.PermissionOverwrite(read_messages=False),  # Cache le salon pour tous
                member: discord.PermissionOverwrite(read_messages=True, send_messages=True),  # Donne accÃ¨s au demandeur
                discord.utils.get(guild.roles, id=STAFF_ROLE_ID): discord.PermissionOverwrite(read_messages=True)  # Donne accÃ¨s au staff
            }

            try:
                channel = await guild.create_text_channel(ticket_name, category=category, overwrites=overwrites)

                # Message dans le ticket
                await channel.send(
                    f"ğŸŸï¸ **Ticket ouvert !**\n\n"
                    f"Salut {member.mention} ! Un membre du staff va bientÃ´t te rÃ©pondre.\n"
                    f"Explique ton problÃ¨me en dÃ©tail pour qu'on puisse tâ€™aider au mieux ! ğŸ˜Š"
                )

                print(f"âœ… Ticket crÃ©Ã© : {channel.name} pour {member.name}")
            except Exception as e:
                print(f"âŒ Erreur lors de la crÃ©ation du ticket : {e}")

# Commande pour envoyer le message du rÃ¨glement avec rÃ©action âœ…
@bot.command()
async def setup_reglement(ctx):
    channel = discord.utils.get(ctx.guild.text_channels, name="ğŸ“–-reglement")

    if channel:
        message = await channel.send(
            "Bienvenue sur notre serveur !\n\n"
            "Voici le rÃ¨glement du serveur :\n"
            "1. Respectez les autres membres.\n"
            "2. Aucun contenu offensant.\n"
            "3. Pas de spam.\n\n"
            "Cliquez sur âœ… pour accepter et obtenir le rÃ´le Membres."
        )
        await message.add_reaction("âœ…")
    else:
        print("âŒ Aucun salon 'ğŸ“–-reglement' trouvÃ© dans le serveur.")

# Commande pour envoyer le message du systÃ¨me de tickets avec rÃ©action ğŸŸ¢
@bot.command()
async def setup_ticket(ctx):
    channel = discord.utils.get(ctx.guild.text_channels, name="ğŸ“¥-demande-ticket")

    if channel:
        message = await channel.send(
            "ğŸŸ¢ Besoin d'aide ou d'une optimisation ? Ouvre un ticket ! ğŸŸï¸\n\n"
            "Tu souhaites une assistance personnalisÃ©e ou une optimisation ?\n"
            "Aucun souci ! Clique sur la rÃ©action ğŸŸ¢ juste en dessous pour crÃ©er ton ticket.\n\n"
            "âœ… **Comment Ã§a marche ?**\n"
            "1ï¸âƒ£ Clique sur ğŸŸ¢ pour ouvrir un ticket.\n"
            "2ï¸âƒ£ Un salon privÃ© sera crÃ©Ã© pour toi.\n"
            "3ï¸âƒ£ Explique ton besoin et un membre du staff tâ€™aidera !\n\n"
            "ğŸ”’ **Seuls toi et le staff auront accÃ¨s au ticket**\n"
            "â¡ï¸ **Appuie sur ğŸŸ¢ pour commencer !**"
        )
        await message.add_reaction("ğŸŸ¢")
    else:
        print("âŒ Le salon ğŸ“¥-demande-ticket n'a pas Ã©tÃ© trouvÃ© !")

# RÃ©cupÃ©rer le token du bot depuis une variable d'environnement
token = os.environ['tokendiscord']